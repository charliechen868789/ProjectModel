# lighttpd.conf - Environmental Monitor Dashboard
server.modules = (
    "mod_access",
    "mod_alias", 
    "mod_compress",
    "mod_redirect",
    "mod_proxy",
    "mod_setenv"
)

# Basic server configuration
server.document-root = "/home/chen/www/environmental-monitor"
server.upload-dirs = ( "/home/chen/www/cache/lighttpd/uploads" )
server.errorlog = "/home/chen/www/log/lighttpd/error.log"
server.pid-file = "/var/run/lighttpd.pid"
server.username = "www-data"
server.groupname = "www-data"
server.port = 8080

# Default files to serve
index-file.names = ( "index.html" )

# Security settings
url.access-deny = ( "~", ".inc" )
static-file.exclude-extensions = ( ".php", ".pl", ".fcgi" )

# Compression for better performance
compress.cache-dir = "/var/cache/lighttpd/compress/"
compress.filetype = ( 
    "application/javascript", 
    "text/css", 
    "text/html", 
    "text/plain",
    "application/json"
)

# MIME types
mimetype.assign = (
    ".html" => "text/html",
    ".htm" => "text/html",
    ".txt" => "text/plain",
    ".css" => "text/css",
    ".js" => "application/javascript",
    ".json" => "application/json",
    ".jpg" => "image/jpeg",
    ".jpeg" => "image/jpeg",
    ".png" => "image/png",
    ".gif" => "image/gif",
    ".svg" => "image/svg+xml",
    ".ico" => "image/x-icon",
    ".woff" => "font/woff",
    ".woff2" => "font/woff2"
)

# Cache control for static assets
$HTTP["url"] =~ "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$" {
    expire.url = ( "" => "access plus 1 hours" )
}

# Proxy API requests to webapp backend
$HTTP["url"] =~ "^/api" {
    proxy.server = ( "" => ( 
        ( 
            "host" => "127.0.0.1", 
            "port" => 8081 
        )
    ))
    proxy.header = (
        "map-host-request" => ( "-" => "127.0.0.1:8081" ),
        "upgrade" => "enable"
    )
}

# Add CORS headers for API responses
$HTTP["url"] =~ "^/api" {
    setenv.add-response-header = (
        "Access-Control-Allow-Origin" => "*",
        "Access-Control-Allow-Methods" => "GET, POST, OPTIONS",
        "Access-Control-Allow-Headers" => "Content-Type"
    )
}

# Single Page Application routing
# Redirect all non-API, non-static requests to index.html
url.rewrite-once = (
    "^/api" => "$0",
    "^/(css|js|assets|images)/" => "$0",
    "^/[^?]*\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|html)(\?.*)?$" => "$0",
    "^/[^.]*$" => "/index.html"
)

# Optional: Enable directory listing for development (remove in production)
# dir-listing.activate = "enable"

# Optional: Basic auth for production (uncomment if needed)
# auth.debug = 2
# auth.backend = "plain"
# auth.backend.plain.userfile = "/etc/lighttpd/.lighttpdpassword"
# auth.require = ( "/admin/" => (
#     "method"  => "basic",
#     "realm"   => "Environmental Monitor Admin",
#     "require" => "user=admin"
# ))

# Error pages
server.error-handler-404 = "/index.html"