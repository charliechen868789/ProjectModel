<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environment Monitor - Web Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #2196F3;
            color: white;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            margin-bottom: 1rem;
            color: #2196F3;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected { background: #4CAF50; }
        .status-disconnected { background: #F44336; }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .alert-good { background: #E8F5E8; color: #2E7D32; }
        .alert-moderate { background: #FFF3E0; color: #F57C00; }
        .alert-poor { background: #FFEBEE; color: #C62828; }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        
        .btn:hover {
            background: #1976D2;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }
        
        #updateTime {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Environment Monitor - Web Interface</h1>
            <p>Real-time environmental data monitoring and analysis</p>
        </div>
        
        <div id="connectionStatus" class="alert alert-poor">
            <span class="status-indicator status-disconnected"></span>
            <span>Connecting to server...</span>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h3>Current Sensor Data</h3>
                <div class="metric">
                    <span>Temperature:</span>
                    <span class="metric-value" id="temperature">--째C</span>
                </div>
                <div class="metric">
                    <span>Humidity:</span>
                    <span class="metric-value" id="humidity">--%</span>
                </div>
                <div class="metric">
                    <span>Pressure:</span>
                    <span class="metric-value" id="pressure">-- hPa</span>
                </div>
                <div class="metric">
                    <span>Sensor ID:</span>
                    <span class="metric-value" id="sensorId">--</span>
                </div>
                <p id="updateTime">Last update: --</p>
            </div>
            
            <div class="card">
                <h3>Analysis Results</h3>
                <div class="metric">
                    <span>Comfort Index:</span>
                    <span class="metric-value" id="comfortIndex">--/100</span>
                </div>
                <div class="metric">
                    <span>Alert Level:</span>
                    <span class="metric-value" id="alertLevel">--</span>
                </div>
                <div id="recommendation" class="alert alert-good" style="margin-top: 1rem;">
                    <p>No recommendations available</p>
                </div>
            </div>
            
            <div class="card">
                <h3>System Status</h3>
                <div class="metric">
                    <span>Server Status:</span>
                    <span class="metric-value" id="serverStatus">--</span>
                </div>
                <div class="metric">
                    <span>Data History:</span>
                    <span class="metric-value" id="historySize">-- records</span>
                </div>
                <div class="metric">
                    <span>Uptime:</span>
                    <span class="metric-value" id="uptime">--</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <h3>Controls</h3>
            <button class="btn" onclick="refreshData()">Refresh Data</button>
            <button class="btn" onclick="clearHistory()">Clear History</button>
            <button class="btn" onclick="exportData()">Export Data</button>
            <button class="btn" onclick="toggleAutoRefresh()">Toggle Auto-refresh</button>
            
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let autoRefresh = true;
        let refreshInterval;
        let dataChart;
        
        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            dataChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (째C)',
                            data: [],
                            borderColor: '#F44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Humidity (%)',
                            data: [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Pressure (hPa/10)',
                            data: [],
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Values'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // Fetch data from API
        async function fetchSensorData() {
            try {
                const response = await fetch('/api/sensor');
                if (response.ok) {
                    const data = await response.json();
                    updateSensorDisplay(data);
                    return data;
                }
            } catch (error) {
                console.error('Error fetching sensor data:', error);
            }
            return null;
        }
        
        async function fetchAlgorithmResults() {
            try {
                const response = await fetch('/api/algorithm');
                if (response.ok) {
                    const data = await response.json();
                    updateAlgorithmDisplay(data);
                    return data;
                }
            } catch (error) {
                console.error('Error fetching algorithm results:', error);
            }
            return null;
        }
        
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const data = await response.json();
                    updateStatusDisplay(data);
                    updateConnectionStatus(true);
                    return data;
                }
            } catch (error) {
                console.error('Error fetching status:', error);
                updateConnectionStatus(false);
            }
            return null;
        }
        
        async function fetchHistory() {
            try {
                const response = await fetch('/api/history?limit=20');
                if (response.ok) {
                    const data = await response.json();
                    updateChart(data.data);
                    return data;
                }
            } catch (error) {
                console.error('Error fetching history:', error);
            }
            return null;
        }
        
        // Update display functions
        function updateSensorDisplay(data) {
            document.getElementById('temperature').textContent = 
                data.temperature ? data.temperature.toFixed(1) + '째C' : '--째C';
            document.getElementById('humidity').textContent = 
                data.humidity ? data.humidity.toFixed(1) + '%' : '--%';
            document.getElementById('pressure').textContent = 
                data.pressure ? data.pressure.toFixed(1) + ' hPa' : '-- hPa';
            document.getElementById('sensorId').textContent = 
                data.sensor_id || '--';
            document.getElementById('updateTime').textContent = 
                data.time ? 'Last update: ' + new Date(data.time).toLocaleTimeString() : 'Last update: --';
        }
        
        function updateAlgorithmDisplay(data) {
            document.getElementById('comfortIndex').textContent = 
                data.comfort_index ? Math.round(data.comfort_index) + '/100' : '--/100';
            document.getElementById('alertLevel').textContent = 
                data.alert_level || '--';
            
            const recommendationEl = document.getElementById('recommendation');
            if (data.recommendation) {
                recommendationEl.innerHTML = '<p>' + data.recommendation + '</p>';
                
                // Update alert style based on alert level
                recommendationEl.className = 'alert ';
                switch(data.alert_level) {
                    case 'GOOD':
                        recommendationEl.className += 'alert-good';
                        break;
                    case 'MODERATE':
                        recommendationEl.className += 'alert-moderate';
                        break;
                    case 'POOR':
                    case 'CRITICAL':
                        recommendationEl.className += 'alert-poor';
                        break;
                    default:
                        recommendationEl.className += 'alert-good';
                }
            }
        }
        
        function updateStatusDisplay(data) {
            document.getElementById('serverStatus').textContent = 
                data.has_sensor_data ? 'Connected' : 'No Data';
            document.getElementById('historySize').textContent = 
                (data.history_size || 0) + ' records';
            document.getElementById('uptime').textContent = 
                data.uptime || '--';
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const indicator = statusEl.querySelector('.status-indicator');
            const text = statusEl.querySelector('span:last-child');
            
            if (connected) {
                statusEl.className = 'alert alert-good';
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'Connected to server';
            } else {
                statusEl.className = 'alert alert-poor';
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'Connection lost - retrying...';
            }
        }
        
        function updateChart(historyData) {
            if (!historyData || historyData.length === 0) return;
            
            const labels = [];
            const tempData = [];
            const humidityData = [];
            const pressureData = [];
            
            historyData.forEach(item => {
                labels.push(new Date(item.timestamp).toLocaleTimeString());
                tempData.push(item.temperature);
                humidityData.push(item.humidity);
                pressureData.push(item.pressure / 10); // Scale pressure for display
            });
            
            dataChart.data.labels = labels;
            dataChart.data.datasets[0].data = tempData;
            dataChart.data.datasets[1].data = humidityData;
            dataChart.data.datasets[2].data = pressureData;
            dataChart.update();
        }
        
        // Control functions
        async function refreshData() {
            await Promise.all([
                fetchSensorData(),
                fetchAlgorithmResults(),
                fetchStatus(),
                fetchHistory()
            ]);
        }
        
        async function clearHistory() {
            try {
                await fetch('/api/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: 'clear_history'
                    })
                });
                await refreshData();
            } catch (error) {
                console.error('Error clearing history:', error);
            }
        }
        
        async function exportData() {
            try {
                const historyResponse = await fetch('/api/history');
                if (historyResponse.ok) {
                    const data = await historyResponse.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], 
                                        { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'environment_data_' + new Date().toISOString().split('T')[0] + '.json';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Error exporting data:', error);
            }
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            
            if (autoRefresh) {
                startAutoRefresh();
            } else {
                clearInterval(refreshInterval);
            }
            
            const btn = event.target;
            btn.textContent = autoRefresh ? 'Stop Auto-refresh' : 'Start Auto-refresh';
            btn.style.backgroundColor = autoRefresh ? '#F44336' : '#4CAF50';
        }
        
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 2000);
        }
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            refreshData();
            
            if (autoRefresh) {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>